# Ensure the 'postgresadmin' role exists
$roleCheckCmd = "DO \$\$ BEGIN IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'postgresadmin') THEN CREATE ROLE postgresadmin WITH LOGIN SUPERUSER; END IF; END \$\$;"
& "$PSQL" -h $PGHOST -p $PGPORT -U $PGUSER -d postgres -c $roleCheckCmd

foreach ($db in $databases) {
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $dumpPath = Join-Path $DUMP_ROOT $db
    $outLog = Join-Path $LOG_ROOT "$db-restore-$timestamp.out.log"
    $errLog = Join-Path $LOG_ROOT "$db-restore-$timestamp.err.log"

    if (!(Test-Path $dumpPath)) {
        Write-Warning "ðŸš« Dump path not found for $db. Skipping..."
        continue
    }

    Write-Host "`nðŸ§¹ Dropping and recreating DB: $db"
    & "$PSQL" -h $PGHOST -p $PGPORT -U $PGUSER -d postgres -c "DROP DATABASE IF EXISTS $db;"
    & "$PSQL" -h $PGHOST -p $PGPORT -U $PGUSER -d postgres -c "CREATE DATABASE $db;"
    Start-Sleep -Seconds 2

    # --- Schema Restore ---
    $schemaArgs = @(
        "-h", $PGHOST,
        "-p", $PGPORT,
        "-U", $PGUSER,
        "-d", $db,
        "-Fd", "`"$dumpPath`"",
        "--no-owner",
        "-s",
        "-j", "1"
    )
    Write-Host "ðŸ“ Restoring schema for $db..."
    Start-Process -FilePath $PG_RESTORE -ArgumentList $schemaArgs -NoNewWindow -Wait `
        -RedirectStandardOutput $outLog `
        -RedirectStandardError $errLog

    # --- Data Restore ---
    $dataArgs = @(
        "-h", $PGHOST,
        "-p", $PGPORT,
        "-U", $PGUSER,
        "-d", $db,
        "-Fd", "`"$dumpPath`"",
        "--no-owner",
        "-a",
        "-j", "8"
    )
    Write-Host "ðŸ“¦ Restoring data for $db..."
    Start-Process -FilePath $PG_RESTORE -ArgumentList $dataArgs -NoNewWindow -Wait `
        -RedirectStandardOutput $outLog `
        -RedirectStandardError $errLog

    Write-Host "âœ… Completed restoring $db. Logs at $outLog and $errLog"
}








tune.sql
SET maintenance_work_mem = '512MB';
SET checkpoint_timeout = '1800';
SET max_wal_size = '8192';

%PG_BIN%\psql.exe -h your-rds-endpoint.rds.amazonaws.com -p 5432 -U postgresadmin -d %DBNAME% -f tune.sql



bat file:
@echo off
setlocal enabledelayedexpansion
set PGPASSWORD=your-password

REM Inputs: %1 = dbname
set DBNAME=%1
set DUMP=C:\pg_dumps\%DBNAME%

echo âœ… Restoring schema for %DBNAME%
"C:\Program Files\PostgreSQL\16\bin\pg_restore.exe" -h your-rds-endpoint.rds.amazonaws.com -p 5432 -U your-user -d %DBNAME% --no-owner -Fd "%DUMP%" -s -j 1

echo âœ… Restoring data for %DBNAME%
"C:\Program Files\PostgreSQL\16\bin\pg_restore.exe" -h your-rds-endpoint.rds.amazonaws.com -p 5432 -U your-user -d %DBNAME% --no-owner -Fd "%DUMP%" -a -j 8






$databases = @("db1", "db2", "db3", "db4", "db5", "db6", "db7", "db8", "db9", "db10")

foreach ($db in $databases) {
    cmd.exe /c restore.bat $db
}














@echo off
setlocal enabledelayedexpansion

REM === CONFIGURATION ===
set PGPASSWORD=your-password
set DBNAME=%1
set DUMP_PATH=C:\pg_dumps\%DBNAME%
set PGHOST=rma-dev-hydra-aurorapg01-instance-1.ci14swg84unm.us-east-1.rds.amazonaws.com
set PGPORT=5432
set PGUSER=your-user
set PG_BIN=C:\Program Files\PostgreSQL\16\bin

REM === LOGS ===
set LOGDIR=C:\pg_restore_logs
if not exist %LOGDIR% mkdir %LOGDIR%
set OUTLOG=%LOGDIR%\%DBNAME%-restore.out.log
set ERRLOG=%LOGDIR%\%DBNAME%-restore.err.log

echo ðŸ” Checking if database [%DBNAME%] exists...
"%PG_BIN%\psql.exe" -h %PGHOST% -p %PGPORT% -U %PGUSER% -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname = '%DBNAME%';" | findstr 1 >nul

IF %ERRORLEVEL%==0 (
    echo âš ï¸  Database [%DBNAME%] exists â€” dropping...
    "%PG_BIN%\psql.exe" -h %PGHOST% -p %PGPORT% -U %PGUSER% -d postgres -c "DROP DATABASE IF EXISTS %DBNAME%;" >> %OUTLOG% 2>> %ERRLOG%
)

echo ðŸ†• Creating database [%DBNAME%]...
"%PG_BIN%\psql.exe" -h %PGHOST% -p %PGPORT% -U %PGUSER% -d postgres -c "CREATE DATABASE %DBNAME%;" >> %OUTLOG% 2>> %ERRLOG%

REM === Restore schema ===
echo ðŸ“ Restoring schema for [%DBNAME%]...
"%PG_BIN%\pg_restore.exe" ^
 -h %PGHOST% ^
 -p %PGPORT% ^
 -U %PGUSER% ^
 -d %DBNAME% ^
 --no-owner ^
 -Fd "%DUMP_PATH%" ^
 -s ^
 -j 1 >> %OUTLOG% 2>> %ERRLOG%

REM === Restore data ===
echo ðŸ“¦ Restoring data for [%DBNAME%]...
"%PG_BIN%\pg_restore.exe" ^
 -h %PGHOST% ^
 -p %PGPORT% ^
 -U %PGUSER% ^
 -d %DBNAME% ^
 --no-owner ^
 -Fd "%DUMP_PATH%" ^
 -a ^
 -j 8 >> %OUTLOG% 2>> %ERRLOG%

echo âœ… Restore complete for [%DBNAME%]
echo ðŸ“ Logs:
echo   âž¤ %OUTLOG%
echo   âž¤ %ERRLOG%
pause










REM === DROP DB ===
echo ðŸ§¹ Dropping database [%DBNAME%] (if exists)...
"%PG_BIN%\psql.exe" -h %PGHOST% -p %PGPORT% -U %PGUSER% -d postgres -c "DROP DATABASE IF EXISTS %DBNAME%;" >> %OUTLOG% 2>> %ERRLOG%

REM === CREATE DB ===
echo ðŸ— Creating database [%DBNAME%]...
"%PG_BIN%\psql.exe" -h %PGHOST% -p %PGPORT% -U %PGUSER% -d postgres -c "CREATE DATABASE %DBNAME%;" >> %OUTLOG% 2>> %ERRLOG%

REM === SCHEMA RESTORE ===
echo ðŸ“ Restoring schema...
"%PG_BIN%\pg_restore.exe" -j 1 -h %PGHOST% -p %PGPORT% -U %PGUSER% -d %DBNAME% --no-owner -Fd "%DUMP_PATH%" -s >> %OUTLOG% 2>> %ERRLOG%

REM === DATA RESTORE ===
echo ðŸ“¦ Restoring data...
"%PG_BIN%\pg_restore.exe" -j 8 -h %PGHOST% -p %PGPORT% -U %PGUSER% -d %DBNAME% --no-owner -Fd "%DUMP_PATH%" -a >> %OUTLOG% 2>> %ERRLOG%

echo âœ… Done! Logs at:
echo %OUTLOG%
echo %ERRLOG%
pause
