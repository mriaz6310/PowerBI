CREATE OR REPLACE TEMP VIEW silver_fact_resources_txn1 AS
SELECT
    -- Static or derived dimensions
    -1 AS dim_vendor_id,
    NULL AS dim_period_id,     -- You can join to a period dim later if needed
    NULL AS dim_project_id,
    NULL AS dim_employee_id,
    NULL AS dim_account_id,
    NULL AS dim_organization_id,
    1 AS dim_transaction_type_id,

    -- Basic joins and IDs
    l.ts_hdr_seq_no,
    l.ts_ln_key,
    l.ts_ln_no,
    h.ts_dt,
    h.empl_id,
    l.pay_type,

    -- Core calculations
    CASE 
        WHEN l.entered_hrs <> 0 THEN l.lab_cst_amt / l.entered_hrs 
        ELSE 0 
    END AS hourly_rate,

    l.entered_hrs AS hours,
    l.entered_hrs AS hours_pool_calc,
    l.lab_cst_amt AS lab_cost_amt,

    -- Handling nulls with defaults
    COALESCE(l.bill_lab_cat_cd, '-NA') AS bill_lab_cat_cd,
    COALESCE(l.genl_lab_cat_cd, '-NA') AS genl_lab_cat_cd,
    COALESCE(l.lab_loc_cd, '-NA') AS lab_loc_cd,

    -- Derived logic for flags
    CASE 
        WHEN l.s_ts_type_cd = 'C' AND (
            l.notes LIKE '%75 line%' OR l.notes LIKE '%75line%'
        ) THEN 1 
        ELSE 0 
    END AS ppa_flag,

    CASE 
        WHEN l.s_ts_type_cd = 'C' AND h.ts_hdr_seq_no = 1 AND l.ts_ln_no = 1 THEN 1 
        ELSE 0 
    END AS ppa_count,

    l.notes,
    l.time_stamp AS last_modified_date,
    current_timestamp() AS created_date,
    'bronze_to_silver_job' AS created_user
FROM ts_hdr_hs h
INNER JOIN ts_ln_hs l
  ON h.ts_dt = l.ts_dt
 AND h.empl_id = l.empl_id
 AND h.s_ts_type_cd = l.s_ts_type_cd
 AND h.ts_hdr_seq_no = l.ts_hdr_seq_no;


