CREATE OR REPLACE TEMP VIEW fact_resources_txn1 AS
SELECT
  -1 AS dim_vendor_id,
  p.dim_period_id,
  p.dim_project_id,
  e.dim_employee_id,
  a.dim_glaccount_id,
  o.dim_organization_id,
  1 AS dim_transaction_type_id,
  1 AS dim_pool_id,
  -1 AS dim_vendor_emplid,
  sp.dim_schedule_period_id,
  COALESCE(ts.dim_ts_id, -1) AS dim_ts_id,
  l.ts_hdr_seq_no,
  l.ts_ln_key,
  l.ts_ln_no,
  l.ts_dt,
  'E' AS resource_type,
  CASE WHEN l.entered_hrs <> 0 THEN l.lab_cst_amt / l.entered_hrs ELSE 0 END AS hourly_rate,
  l.entered_hrs AS hours,
  l.entered_hrs AS hours_pool_calc,
  l.lab_cst_amt,
  l.entered_hrs AS entered_hrs,
  l.chg_hrs AS chg_hrs,
  CASE WHEN l.pay_type IN ('S10', 'S15') THEN 0 ELSE l.chg_hrs END AS hours_reported,
  h.ts_dt AS hours_date,
  COALESCE(l.pay_type, '-NA') AS pay_type,
  COALESCE(l.bill_lab_cat_cd, '-NA') AS bill_lab_cat_cd,
  COALESCE(l.genl_lab_cat_cd, '-NA') AS genl_lab_cat_cd,
  COALESCE(l.lab_loc_cd, '-NA') AS lab_loc_cd,
  l.s_ts_type_cd,
  l.lab_cst_amt AS amt_target,
  l.lab_cst_amt AS amt_actual,
  CASE
    WHEN rpl.s_rev_formula_cd = 'CPFH' THEN l.lab_cst_amt + l.entered_hrs * rpl.rev_calc_amt
    WHEN rpl.s_rev_formula_cd = 'CPFC' THEN l.lab_cst_amt * (1 + rpl.rev_calc_amt / 100)
    WHEN rr.bill_rt_amt IS NULL THEN 0
    WHEN rpl.s_rev_formula_cd IN ('LLRCINLB', 'LLRCINL', 'LLR') THEN l.entered_hrs * rr.bill_rt_amt
    ELSE 0
  END AS amt_revenue,
  CASE
    WHEN bdh.billed_amt IS NOT NULL THEN bdh.billed_amt
    ELSE 0
  END AS amt_billing,
  l.lab_cst_amt AS direct_cost,
  0 AS indirect_cost,
  CASE
    WHEN l.s_ts_type_cd = 'C' AND (l.notes LIKE '%75 line%' OR l.notes LIKE '%75line%') THEN 1
    ELSE 0
  END AS ppa_flag,
  CASE
    WHEN l.s_ts_type_cd = 'C' AND h.ts_hdr_seq_no = 1 AND l.ts_ln_no = 1 THEN 1
    ELSE 0
  END AS ppa_count,
  DATEDIFF(day, COALESCE(h.pay_pd_end_dt, h.ts_dt), t.period_date) AS ppa_days,
  l.notes AS notes,
  current_timestamp() AS created_date,
  'ETL_Process' AS created_user,
  l.time_stamp AS last_modified_date,
  'ETL_Process' AS last_modified_user
FROM TS_HDR_HS h
JOIN TS_LN_HS l
  ON h.ts_dt = l.ts_dt AND h.empl_id = l.empl_id AND h.s_ts_type_cd = l.s_ts_type_cd
JOIN DIM_PROJECT p ON l.proj_id = p.proj_id
LEFT JOIN DIM_PROJECT rpl ON p.revenue_proj_lvl_dim_project_id = rpl.dim_project_id
JOIN DIM_GLACCOUNT a ON l.acct_id = a.acct_id
JOIN DIM_ORGANIZATION o ON l.org_id = o.org_id
LEFT JOIN DIM_SCHEDULE_PERIOD sp
  ON CASE WHEN h.pd_no = 13 THEN l.ts_dt ELSE COALESCE(h.pay_pd_end_dt, h.ts_dt) END = sp.end_dt
JOIN DIM_PERIOD t ON h.fy_cd = t.fy_cd AND h.pd_no = t.pd_no
JOIN DIM_EMPLOYEE e
  ON h.empl_id = e.empl_id AND h.ts_dt BETWEEN e.effective_date AND e.expiration_date
LEFT JOIN SYN_BILLING_DETL_HIST bdh
  ON l.ts_dt = bdh.ts_dt AND l.empl_id = bdh.id
WHERE l.time_stamp >= date_sub(current_date(), 7); -- Example filter for recent data
